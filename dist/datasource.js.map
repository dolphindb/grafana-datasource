{"version":3,"sources":["../src/datasource.js"],"names":["_","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","q","withCredentials","headers","basicAuth","length","options","query","buildQueryParameters","targets","filter","t","hide","when","data","getAdhocFilters","adhocFilters","doRequest","method","then","res","results","key","queryRes","series","i","push","target","datapoints","points","refId","meta","tables","table","format","response","status","message","title","replace","annotation","annotationQuery","range","datasource","enable","iconColor","rangeRaw","result","interpolated","mapToTextValue","map","d","text","value","isObject","datasourceRequest","sql","rawSql","from","to","queries","Promise","resolve","reject","isUTC","_isUTC","year","PrefixInteger","month","date","hour","minute","second","millisecond","num","Array","join","slice"],"mappings":"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","file":"datasource.js","sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n    constructor(instanceSettings, $q, backendSrv, templateSrv) {\n        this.type = instanceSettings.type;\n        this.url = instanceSettings.url;\n        this.name = instanceSettings.name;\n        this.q = $q;\n        this.backendSrv = backendSrv;\n        this.templateSrv = templateSrv;\n        this.withCredentials = instanceSettings.withCredentials;\n        this.headers = { 'Content-Type': 'application/json' };\n        if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n            this.headers['Authorization'] = instanceSettings.basicAuth;\n        }\n    }\n\n    query(options) {\n        var query = this.buildQueryParameters(options);\n        query.targets = query.targets.filter(t => !t.hide);\n\n        if (query.targets.length <= 0) {\n            return this.q.when({ data: [] });\n        }\n\n        if (this.templateSrv.getAdhocFilters) {\n            query.adhocFilters = this.templateSrv.getAdhocFilters(this.name);\n        } else {\n            query.adhocFilters = [];\n        }\n\n        return this.doRequest({\n            url: this.url,\n            data: query,\n            method: 'POST'\n        }).then(res => {\n            var data = [];\n\n            if (!res.data.results) {\n                return {\n                    data: data\n                };\n            }\n\n            for (var key in res.data.results) {\n                var queryRes = res.data.results[key];\n                if (queryRes.series) {\n                    for (var i = 0; i < queryRes.series.length; i++) {\n                        var series = queryRes.series[i];\n                        data.push({\n                            target: series.name,\n                            datapoints: series.points,\n                            refId: queryRes.refId,\n                            meta: queryRes.meta,\n                        });\n                    }\n                }\n\n                if (queryRes.tables) {\n                    for (var i = 0;i < queryRes.tables.length; i++) {\n                        var table = queryRes.tables[i];\n                        table.format = 'table';\n                        table.refId = queryRes.refId;\n                        table.meta = queryRes.meta;\n                        data.push(table);\n                    }\n                }\n            }\n\n            return {\n                data: data\n            };\n        });\n    }\n\n    testDatasource() {\n        return this.doRequest({\n            url: this.url,\n            method: 'POST',\n        }).then(response => {\n            if (response.status === 200) {\n                return { status: \"success\", message: \"Data source is working\", title: \"Success\" };\n            }\n        });\n    }\n\n    annotationQuery(options) {\n        var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n        var annotationQuery = {\n            range: options.range,\n            annotation: {\n                name: options.annotation.name,\n                datasource: options.annotation.datasource,\n                enable: options.annotation.enable,\n                iconColor: options.annotation.iconColor,\n                query: query\n            },\n            rangeRaw: options.rangeRaw\n        };\n\n        return this.doRequest({\n            url: this.url + '/annotations',\n            method: 'POST',\n            data: annotationQuery\n        }).then(result => {\n            return result.data;\n        });\n    }\n\n    metricFindQuery(query) {\n        var interpolated = {\n            target: this.templateSrv.replace(query, null, 'regex')\n        };\n\n        return this.doRequest({\n            url: this.url + '/search',\n            data: interpolated,\n            method: 'POST',\n        }).then(this.mapToTextValue);\n    }\n\n    mapToTextValue(result) {\n        return _.map(result.data, (d, i) => {\n            if (d && d.text && d.value) {\n                return { text: d.text, value: d.value };\n            } else if (_.isObject(d)) {\n                return { text: d, value: i };\n            }\n            return { text: d, value: d };\n        });\n    }\n\n    doRequest(options) {\n        options.withCredentials = this.withCredentials;\n        options.headers = this.headers;\n\n        return this.backendSrv.datasourceRequest(options);\n    }\n   \n    buildQueryParameters(options) {\n        \n        var targets = _.map(options.targets, target => {\n            var sql = target.rawSql;\n            sql = sql.replace(\"$__timeFilter_UTC\", \"pair(\" + this.format(options.range.from,true) + \",\" + this.format(options.range.to,true) + \")\");\n            sql = sql.replace(\"$__timeFilter\", \"pair(\" + this.format(options.range.from,false) + \",\" + this.format(options.range.to,false) + \")\");\n            return {\n                rawSql: sql,\n                refId: target.refId,\n                hide: target.hide,\n                format: target.format || 'time_series'\n            };\n        });\n\n        options.queries = targets;\n        options.targets = targets;\n        return options;\n    }\n\n    getTagKeys(options) {\n        return new Promise((resolve, reject) => {\n            this.doRequest({\n                url: this.url + '/tag-keys',\n                method: 'POST',\n                data: options\n            }).then(result => {\n                return resolve(result.data);\n            });\n        });\n    }\n\n    getTagValues(options) {\n        return new Promise((resolve, reject) => {\n            this.doRequest({\n                url: this.url + '/tag-values',\n                method: 'POST',\n                data: options\n            }).then(result => {\n                return resolve(result.data);\n            });\n        });\n    }\n\n    format(d, isUTC) {\n        d._isUTC = isUTC;\n        return d.year() + \".\" + this.PrefixInteger(d.month() + 1,2) + \".\" + this.PrefixInteger(d.date(),2) + \"T\" + this.PrefixInteger(d.hour(),2) + \":\" + this.PrefixInteger(d.minute(),2) + \":\" + this.PrefixInteger(d.second(),2) + \".\" + this.PrefixInteger(d.millisecond(),3);\n    }\n\n    PrefixInteger(num, length) {  \n        return (Array(length).join('0') + num).slice(-length);  \n    }\n}\n"]}